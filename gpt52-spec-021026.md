# spec.md — WOW Agentic PDF Studio (Streamlit on Hugging Face Spaces)
## Comprehensive Technical Specification (Updated Design, Dual PDF Engines + Multi-Format Export)

### Document Control
- **Product Name:** WOW Agentic PDF Studio  
- **Deployment Target:** Hugging Face Spaces (Streamlit)  
- **Primary Goal:** Transform user-provided forms or PDF Build Specs into **dynamic, fillable PDFs** with a “WOW” UI and an agentic, step-by-step workflow.
- **Key Enhancement in this revision:**  
  1) **Selectable PDF generation engine:** **fpdf2** or **ReportLab**  
  2) **Selectable download artifact format:** **PDF**, **Python generator script (PY)**, or **jsPDF generator script (JS)**  
  3) **Unicode-capable pipeline** (font embedding strategy + fallback behavior)  
  4) Default spec persisted as **`defaultpdfspec.md`** and loaded at startup

---

## 1. Scope & Objectives

### 1.1 In Scope
The system must provide:
- A WOW UI with:
  - Light/Dark themes
  - English / Traditional Chinese localization
  - 20 painter-inspired styles + Jackpot random style
- A step-by-step agentic workflow (agents.yaml + SKILL.md integration points) where users can:
  - Configure per-agent prompt
  - Set max-tokens (default 12000)
  - Select model per agent (OpenAI/Gemini/Anthropic/Grok options)
  - Edit each agent’s output (Text/Markdown)
  - Use edited output as input to the next agent
- A **Form → Dynamic PDF** pathway:
  - Paste or upload application forms: `.txt`, `.md`, `.docx`
  - Normalize and process forms via agents
  - Generate a dynamic fillable PDF
- A **Spec → Dynamic PDF** pathway (NEW in prior iterations, enhanced here):
  - Paste a PDF Build Spec (TXT/Markdown, YAML/JSON)
  - Validate and normalize it
  - Generate a dynamic fillable PDF using user-selected engine (**fpdf2** or **ReportLab**)
  - Preview, download, upload modified PDF, reconcile fields against spec
- **AI Note Keeper**:
  - Paste notes (txt/markdown)
  - Transform into organized Markdown
  - Highlight keywords in coral
  - Provide 6 “AI Magics” (including AI Keywords with custom color)
- **Settings & API keys**:
  - Use environment keys when present (never show them)
  - Allow user to input keys in UI when missing (masked; session-only)

### 1.2 Out of Scope
- Fully automated drag-and-drop PDF layout editor (future)
- True digital signature fields (cryptographic signing)
- PDF accessibility tagging (PDF/UA) guarantees (future)
- Guaranteed editability in every browser PDF viewer (varies by viewer)

---

## 2. System Architecture Overview

### 2.1 Runtime Platform
- **Framework:** Streamlit
- **Host:** Hugging Face Spaces
- **Config Files:**
  - `agents.yaml` — agent definitions, step order, tool permissions
  - `SKILL.md` — system prompt/policy for all agents
- **PDF Engines:**
  - Engine A: **fpdf2** (fast, convenient form helpers)
  - Engine B: **ReportLab** (robust AcroForm APIs, production-friendly)

### 2.2 Core Subsystems
1. **WOW UI Layer**
   - Theme, language, painter styles, navigation, dashboards, status indicators
2. **Input & Normalization**
   - Text/Markdown paste
   - File upload handling for txt/md/docx (DOCX extraction)
3. **Agent Orchestration**
   - Editable prompts + outputs per step
   - Model selection per agent
   - Sequential execution with user checkpoints
4. **Spec Validator**
   - Parse YAML/JSON from pasted/Markdown-wrapped content
   - Validate required keys and geometry
   - Normalize units and canonicalize fields
5. **PDF Generation Tooling**
   - fpdf2 generator
   - ReportLab generator
   - Postprocessing (NeedAppearances)
6. **Artifact Export**
   - PDF output
   - PY generator script output
   - JS (jsPDF) script output
7. **Versioning / History**
   - Store versions in session (ephemeral)
   - Save artifacts in a version record for retrieval within session

---

## 3. WOW UI Requirements

### 3.1 Theme Support
- **Light/Dark** global mode affects:
  - Background, text, cards, borders
  - Status chips, buttons, inputs
  - Preview containers and logs
- Theme setting persists in session.

### 3.2 Localization (English / Traditional Chinese)
- All UI labels, warnings, button text, and status strings must be localized.
- Language setting persists in session.

### 3.3 Painter Styles (20) + Jackpot
- 20 UI skins inspired by famous painters (palette + typography accents).
- **Jackpot** randomly selects a style.
- Style selection must not affect functional output except where explicitly configured (PDF styling remains primarily spec-driven).

### 3.4 Navigation Tabs
- Dashboard
- Form → Dynamic PDF
- Agent Pipeline
- **PDF Build Spec → Dynamic PDF**
- AI Note Keeper
- Settings & API Keys
- History / Versions

---

## 4. Status Indicators & Dashboard

### 4.1 Global Status Indicators
- Run state: Idle / Running / Awaiting review / Done / Failed
- Provider readiness: OpenAI, Gemini, Anthropic, Grok (Ready/Missing)
- Last latency measurement (ms)
- Token budget default (12000)

### 4.2 Dashboard Widgets
- Recent activity summary:
  - last PDF generation time
  - source (spec/pipeline)
  - engine used (fpdf2/reportlab)
- Field stats (from most recent spec validation):
  - total fields
  - distribution by type (text, textarea, dropdown, checkbox)
- Pipeline completion ratio

---

## 5. Input Handling & Default Files

### 5.1 Application Form Input
- Paste plain text or Markdown
- Upload `.txt`, `.md`, `.docx`
- DOCX extraction preserves paragraph ordering; tables may be simplified.

### 5.2 Default Form Mock
- `sample.md` is created if missing and loaded at startup for immediate usability.

### 5.3 Default PDF Build Spec
- **`defaultpdfspec.md`** is created if missing and loaded at startup.
- Must demonstrate:
  - Unicode title
  - bilingual labels (English + Traditional Chinese)
  - interactive fields: text, dropdown, checkbox, textarea
- Users can choose to load it from the Spec tab.

---

## 6. PDF Build Spec (PDFSpec) Data Contract

### 6.1 Accepted Spec Input Formats
- YAML or JSON
- Raw text or embedded within Markdown fenced code blocks:
  - ```yaml ... ```
  - ```json ... ```

### 6.2 Minimum Required Structure
- `document`:
  - `title` (string, optional but recommended)
  - `page_size`: `A4` or `LETTER`
  - `orientation`: `portrait` or `landscape`
  - `unit`: `mm` or `pt`
  - `margin`: object with left/top/right/bottom
- `fonts`:
  - `default`: family + size
  - `cjk`: family + size (recommended for Traditional Chinese)
- `pages`: array of page objects
- `pages[].elements`: array of `label` and `field` elements

### 6.3 Element Types
- `label` element:
  - `type: "label"`
  - `text` (string)
  - `x`, `y` (numbers, in declared unit)
  - optional `size`, `style` hint (e.g., `"B"`)
- `field` element:
  - `type: "field"`
  - `field_type`: `text`, `textarea`, `checkbox`, `dropdown` (`combo`)
  - `id` (unique string)
  - `name` (string; used as AcroForm field name)
  - `x`, `y`, `w`, `h` (numbers)
  - optional `options` (required for dropdown)
  - optional `multiline` (for textarea)
  - optional `required` (metadata; not always enforceable in PDF)

### 6.4 Unit Normalization Rules
- The system normalizes geometry to a target unit for the chosen engine:
  - fpdf2 path uses `mm`
  - ReportLab uses points internally but accepts conversion from mm
- Conversion:
  - `pt → mm` via fixed multiplier
  - `mm → pt` via ReportLab `mm` unit constant

### 6.5 Validation Rules
- Parseable YAML/JSON required
- `pages` must be non-empty list
- Every element must have numeric `x,y`
- Every field must have numeric `w,h`, valid `id`
- Field IDs must be unique
- Dropdown/radio require non-empty `options`
- Warnings may be produced for:
  - unknown field types (fallback behavior)
  - too-small field sizes
  - potential overlaps (optional heuristic)

---

## 7. PDF Generation Requirements (Dual Engine)

### 7.1 Common Requirements
- Generated PDF must contain **interactive AcroForm fields** for:
  - Text (single line)
  - Textarea (multi-line)
  - Checkbox
  - Dropdown/Combo
- Output must be compatible with mainstream PDF readers; primary target is **Adobe Acrobat Reader**.
- Provide best-effort in-browser preview; inform users that editing may be limited in browser preview.

### 7.2 Engine A — fpdf2
- Pros:
  - Simple form helper API
  - Fast generation
- Risks:
  - Form appearance differences across viewers
  - API behavior may differ by fpdf2 version
- Must:
  - Register Unicode fonts via add_font (TTF)
  - Select default or CJK font based on text content
  - Create fields via form_* APIs
  - If field creation fails, record errors in render log and optionally fallback to placeholder (configurable policy)

### 7.3 Engine B — ReportLab
- Pros:
  - Mature AcroForm support through `canvas.acroForm`
  - Predictable form field creation
- Must:
  - Register Unicode fonts via `pdfmetrics.registerFont(TTFont(...))`
  - Render labels using appropriate font (default vs CJK)
  - Create fields:
    - `acroForm.textfield(...)` for text/textarea (use multiline flag)
    - `acroForm.checkbox(...)` for checkbox
    - `acroForm.choice(...)` for dropdown
- Coordinate System:
  - Spec uses top-left origin; ReportLab uses bottom-left
  - Convert `y` accordingly using page height in points.

### 7.4 Postprocessing — NeedAppearances
- The system must set `/AcroForm /NeedAppearances true` when possible to improve viewer behavior.
- This is performed as a postprocess step using `pypdf`.
- Note: This improves how fields *appear*; it does not create fields if none exist.

---

## 8. Unicode Strategy

### 8.1 Problem Statement
- Core PDF fonts cannot render Traditional Chinese, and some punctuation will fail without Unicode fonts.
- Without font embedding, viewers may show `???` or missing glyphs.

### 8.2 Solution Requirements
- The system must support Unicode by embedding fonts:
  - DejaVuSans.ttf for general Unicode Latin + punctuation
  - NotoSansTC-Regular.ttf for Traditional Chinese
- Fonts must be obtainable in one of two ways:
  1) Bundled in repo at expected paths (`fonts_cache/...`)
  2) Downloaded at runtime (requires HF Space outbound internet + writable filesystem)

### 8.3 Fallback Behavior
- If fonts are unavailable:
  - Sanitize label text to latin-1-compatible characters
  - Warn in UI: “Fonts unavailable; text may degrade”
  - Continue generation to avoid full outage, unless strict mode is enabled.

---

## 9. Download Artifact Formats (PDF / PY / JS)

### 9.1 PDF Artifact
- The generated PDF bytes from the selected engine (post-processed).
- Download button must provide correct filename and MIME type.

### 9.2 PY Artifact (Generator Script)
- Export a runnable Python script that recreates the PDF from the normalized spec.
- The script must:
  - Include the spec embedded as JSON
  - Include minimal font registration logic
  - Indicate where fonts must be placed (paths) or how to adjust them

### 9.3 JS Artifact (jsPDF Generator Script)
- Export a JS script mirroring the user-provided jsPDF sample approach:
  - Title rendering
  - Iterative label rendering
  - AcroForm field creation for text, checkbox, dropdown
- The conversion from spec to JS “FormStructure” must be best-effort:
  - Map field types
  - Infer labels from nearest preceding label (heuristic)
- This export is primarily for portability and demonstration; it does not guarantee pixel-perfect matching of spec coordinates.

---

## 10. Spec Tab UX Flow (PDF Build Spec → Dynamic PDF)

### 10.1 Left Column: Authoring & Controls
- Spec source selector:
  - Use last valid spec
  - Paste new spec
  - Load defaultpdfspec.md
- Engine selector:
  - fpdf2 / ReportLab
- Download format selector:
  - PDF / PY / JS
- Validation & generation controls:
  - Validate
  - Generate
  - Reset to last valid
- Strict mode toggle
- Unit/page-size fallback controls

### 10.2 Right Column: Preview & Operations
- Preview embedded PDF (iframe) and “Open in new tab” link
- Download selected artifact
- Render log display
- Field count detection display (extracted from generated PDF)
- Upload modified PDF + reconcile vs spec
- Save version (stores selected artifact)

---

## 11. Upload/Reconcile Behavior

### 11.1 Upload
- User can upload a modified PDF.
- The system extracts form fields using `pypdf`:
  - Field names
  - Field types (best-effort)
  - Field count

### 11.2 Reconcile
- Compare:
  - Spec field names vs PDF extracted names
  - Missing fields
  - Extra fields
  - Rename suggestions (heuristic string similarity)

---

## 12. Agentic Pipeline (Preserved Capability)

### 12.1 Step-by-Step Execution
- Each agent step:
  - Model selection
  - Prompt editor
  - Max tokens control (default 12000)
  - Run step / run from here
  - Editable output (text/markdown)
  - Accept output to pass forward

### 12.2 Artifact Hand-off
- A pipeline step may output `PDFSpec`.
- When the PDFSpec step is accepted, the system should allow promoting its output to the Spec tab editor for immediate PDF generation.

---

## 13. Security & Privacy

### 13.1 API Keys
- Environment keys:
  - Detected status only; never shown.
- UI-entered keys:
  - Masked
  - Session-only (not persisted)
- No logging of keys.

### 13.2 User Data
- Uploaded forms and PDFs may contain PII.
- System must display privacy notice and encourage users not to upload sensitive content unless necessary.

---

## 14. Performance & Reliability

- Spec validation must be fast and deterministic.
- PDF generation must provide render logs for troubleshooting.
- Font download should be cached (fonts_cache) and not repeated unnecessarily.
- If font download fails, system should degrade gracefully with warnings, unless strict mode is enabled.

---

## 15. Acceptance Criteria

1. App loads with WOW UI controls: theme, language, painter styles + jackpot.
2. `defaultpdfspec.md` is created if missing and loaded by default in Spec tab.
3. Spec validation correctly detects parse errors and schema issues.
4. User can select **fpdf2** or **ReportLab** and successfully generate a PDF.
5. Generated PDF contains interactive fields (verified by extracted field count > 0).
6. Unicode labels render correctly when fonts are available; otherwise warnings are shown.
7. User can choose download format: PDF/PY/JS and download the appropriate artifact.
8. User can upload a modified PDF and reconcile field differences against the spec.
9. History stores saved artifacts within the current session.

---

## 16. Implementation Notes (Non-Code)
- Dependencies required:
  - streamlit, PyYAML, httpx, fpdf2, reportlab, pypdf, python-docx (optional)
- Fonts:
  - Prefer bundling fonts in repo for deterministic behavior on HF Spaces.
  - Runtime download requires outbound internet enabled.

---

# 20 Comprehensive Follow-up Questions

1. Should ReportLab become the **default engine** for spec-based generation (for reliability), or should fpdf2 remain default (for speed)?
2. Do you want the system to **auto-fallback** to the other engine if the selected engine fails to create form fields?
3. Should the app enforce a “no placeholders” rule (hard fail) if any field creation fails, rather than drawing static fallback boxes?
4. Do you require Unicode support not only for labels but also for **user-entered CJK text in form fields** across major PDF viewers?
5. Should the app bundle DejaVu + Noto fonts in the repo by default to avoid runtime download failures and HF internet restrictions?
6. What is your maximum acceptable font bundle size, and do you want **font subsetting** to reduce PDF output size?
7. Should the spec schema support per-element font selection (e.g., `font: NotoSansTC`) rather than automatic CJK detection?
8. Do you want the exportable PY script to include optional auto-download of fonts (more convenient) or remain offline-only (more deterministic)?
9. For JS export, should it preserve **absolute coordinates** from spec (more accurate) instead of using a simplified auto-layout?
10. Do you want the JS export to include instructions for embedding CJK fonts in jsPDF (requires additional tooling)?
11. Should the system provide a “Preflight” report listing any label text that cannot be rendered due to missing fonts?
12. Should strict mode fail if fonts are unavailable and any non-latin characters are present, rather than sanitizing?
13. Do you need support for additional field types (radio groups, date pickers, signature fields), and which engine should implement them first?
14. Should dropdowns be true ComboBoxes (editable) or strict choices (non-editable), and should this be spec-configurable?
15. Do you want the PDF preview to optionally render pages as images (e.g., via PyMuPDF) to avoid browser viewer limitations?
16. Should the History tab support export/import of a project bundle (spec + pdf + logs) to overcome HF ephemeral sessions?
17. Should agent outputs and specs be validated against a stricter schema (e.g., Pydantic) to prevent malformed specs?
18. Do you want the system to expose advanced PDF settings (NeedAppearances toggle, border styles, default field fonts) in UI controls?
19. What viewers must be supported for “editable”: Acrobat Reader only, or also Chrome/Safari embedded viewers?
20. Should the app include automated tests (golden specs) to confirm that both engines generate PDFs with the expected number/type of fields and correct Unicode rendering?
